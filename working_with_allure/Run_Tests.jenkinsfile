node('master') {
    def hosts = HOSTS.split(',') as List
    stage('run tests') {
        for(each in hosts) {
            node(each){
                try{
                    bat script:'pytest --alluredir=Z:\\working_with_allure\\allure-results D:\\jenkins\\automation\\workspace\\allure_testing\\working_with_allure\\test_dummy.py'
                }
                catch(err) {
                    println err
                    currentBuild.result = 'UNSTABLE'
                }
            }
        }
    }

//     stage('get reports') {
//         for(each in hosts) {
//             def hostName = each
//             try {
//                 timeout(unit: 'SECONDS', time:300) {
//                     node(hostName){
//                         dir("."){
//                             stash name: hostName, includes: "Z:\\working_with_allure\\allure-results\\*"
//                         }
//                     }
//                     dir('.'){
//                         unstash hostName
//                     }
//                 }
//             } catch(err) {
//                 println err
//                 currentBuild.result = 'UNSTABLE'
//                 failedHosts.add(['host': hostName, 'error': "fail during stash report- ${err}"])
//             }
//         }
//     }

    stage('reports') {
        script {
                allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: '/working_with_allure/allure-results']]
                ])
        }
    }
}