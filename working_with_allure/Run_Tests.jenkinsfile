node('master') {
    def hosts = HOSTS.split(',') as List
    stage('run tests') {
        for(each in hosts) {
            node(each){
                try{
                    bat script:'pytest --alluredir=D:\\jenkins\\automation\\workspace\\Run_Tests\\allure-results D:\\jenkins\\automation\\workspace\\allure_testing\\working_with_allure\\test_dummy.py'
                }
                catch(err) {
                    println err
                    currentBuild.result = 'UNSTABLE'
                }
            }
        }
    }

    stage('stash and unstash allure results') {
//         sh 'cp -a /working_with_allure/Run_Tests/allure-results/ /var/jenkins_home/workspace/Run_Tests/'
           for(each in hosts){
               def hostName = each
               try{
                   timeout(unit: 'SECONDS', time:300) {
                       node(hostName){
                           dir("."){
                               stash name: hostName, includes: "\\allure-results\\*"
                           }
                       }
                       dir('.'){
                           unstash hostName
                       }
                   }
               }
               catch(err) {
                   println err
                   currentBuild.result = 'UNSTABLE'
               }
           }
    }

    stage('reports') {
        script {
                allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: '\\allure-results']]
                ])
        }
    }
}